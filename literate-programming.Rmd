---
title: "Literate Programming"
author: "Jon Wheeler"
date: "1/19/2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Welcome!

Today we will be presenting an introduction to R and RStudio, with a special
focus on writing reproducible reports using R Markdown.

This seminar is intended to serve as a high level introduction to these
applications and concepts. We are planning for longer, more in-depth and
hands-on workshops in the near future.

This notebook is publicly available from GitHub, at 
<https://github.com/unmrds/r-markdown-seminar>. The data are described in more
detail below, but if you would like to run the markdown and R code against
the data used for this demonstration, the data are available using a link
that will be provided in the chat.

You are welcome to launch R or RStudio, download the data, and follow along,
but please note that we may not be able to troubleshoot technical issues 
during our session today. Please do feel free to email us afterwards with 
any questions.

### Today's instructors

* Harry Snow, Programmer/Analyst CTSC
* Jon Wheeler, Data Curation Librarian

### What we will cover

* Overview of R and RStudio
* Introduction to Markdown
* Using community developed statistical packages in R
* Writing parameterized reports

## R and RStudio

Content for this section is adapted from the University Libraries' Research
Data Services Coffee and Code workshop on R and RStudio:
<https://github.com/unmrds/cc-R-RStudio>.

## Markdown

Content for this section is adapted from the University Libraries' Research
Data Services Coffee and Code workshop on Reproducibility and Communication
Using Notebooks (Jupyter (python) and R):
<https://github.com/unmrds/cc-reproducibility-communication>.

## About the Data

Our demonstration today uses data about health related behaviors of
high-school students from the Youth Risk Behavior Surveillance System (YRBSS).
The data are available in multiple formats from the Centers for Disease Control
and Prevention: <https://www.cdc.gov/healthyyouth/data/yrbs/index.htm>.

The dataset we're using is the _Combined YRBS High School Dataset_, which
contains data from every participating high school during each survey year. For
our purposes, the data have been pre-processed a little from the dataset as
provided in MS Access format for states beginning with letters N - Z. 
Specifically, we:

1. Queried the database for NM data for the years 2011, 2013, 2015, 2017, 2019.
2. Exported each year's data in Excel format.

The data are not included in the GitHub repository for this seminar, mainly
because of uncertainty regarding access and use limitations on the data.

## Working with the Data in RStudio



```{r load_packages, echo=TRUE, include=TRUE, message=FALSE}
library(tidyverse)
library(readxl)
library(ggplot2)
library(crosstable)
```



```{r read_data, echo=TRUE, include=TRUE, message=FALSE}
yrbssNM2019 <- read_excel("./data/sadcqn_nm2019.xlsx")
```

Get information about the imported data.

```{r}
# spec(yrbssNM2019) # doesn't work on Excel
problems(yrbssNM2019)
```

## Including Plots

You can also embed plots, for example:

```{r yrbssNMplot, echo=FALSE}
plot(x = yrbssNM2019$bmi, y = yrbssNM2019$age)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

The data include many categorical variables - if we want to run certain 
models we will have to coerce variable data types. But for now we can draw more informative plots and interrogate the data as-is.

```{r proportion_table}
# note that sum of all values is 1
prop.table(table(yrbssNM2019$grade, yrbssNM2019$sex))
```

Draw a plot. Use additional variables for aesthetics. Adds more information
to the plot. Alpha value helps us to see concentrations of data points.

```{r plot weight/grade}
ggplot(yrbssNM2019, mapping = aes(x = grade, y = stweight)) + 
         geom_point(alpha = 0.05, aes(color = stheight, size = bmi))
```
Manipulate the data - we want to be able to produce some summary statistics similar
to the YRBSS web page.

Coerce some variables into factors.

```{r sex_factor}

# Documentation says A for female, B for male, but we have values of 1 and 2...
# assume 1 == female, 2 == male
yrbssNM2019$sex <- as.factor(yrbssNM2019$sex)
levels(yrbssNM2019$sex)
levels(yrbssNM2019$sex)[1] <- "female"
levels(yrbssNM2019$sex)[2] <- "male"
levels(yrbssNM2019$sex)
plot(yrbssNM2019$sex) # omits NAs
```
```{r race4_factor}

yrbssNM2019$race4 <- factor(yrbssNM2019$race4,
                            labels = c("White", 
                                       "Black or African American", 
                                       "Hispanic/Latino", 
                                       "All other races"))
levels(yrbssNM2019$race4)
plot(yrbssNM2019$race4)
```
```{r race7_factor}

yrbssNM2019$race7 <- factor(yrbssNM2019$race7,
                            labels = c("American Indian/Alaska Native", 
                                       "Asian", 
                                       "Black or African American", 
                                       "Hispanic/Latino",
                                       "Native Hawaiian/Other Pacific Islander",
                                       "White",
                                       "Multiple Races (Non-Hispanic)"))
levels(yrbssNM2019$race7)
plot(yrbssNM2019$race7)
```
```{r obesity_factor}

yrbssNM2019$qnobese <- factor(yrbssNM2019$qnobese, labels = c("obese", "not obese"))
levels(yrbssNM2019$qnobese)
plot(yrbssNM2019$qnobese)
```
Factors below for overweight should be treated with caution. We are using them
for example purposes, but based on the data we don't know that the labels
are correct.

```{r overweight_factor}

yrbssNM2019$qnowt <- factor(yrbssNM2019$qnowt, labels = c("overweight", "not overweight"))
levels(yrbssNM2019$qnowt)
plot(yrbssNM2019$qnowt)
```

The labels for the factors levels will now be used in tables and plots.

```{r prop_table_mf_factors}
# note that sum of all values is 1
prop.table(table(yrbssNM2019$grade, yrbssNM2019$sex))
```

```{r plot race7/bmi/sex}
ggplot(yrbssNM2019, mapping = aes(x = sex, y = bmi)) + 
         geom_boxplot(aes(fill = qnobese)) + 
         facet_wrap(~ race7) +
         labs(x = "Sex", y = "Body Mass Index", 
              title = "BMI by Race and Sex")
```
Continue to coerce variables to factors. We won't do all of them, but we can 
complete the demographic and sexual minority variables.

```{r sexual_minority_factors}
yrbssNM2019$q66 <- factor(yrbssNM2019$q66, labels = c("heterosexual",
                                                      "gay or lesbian",
                                                      "bisexual",
                                                      "not sure"))
yrbssNM2019$q65 <- factor(yrbssNM2019$q65, labels = c("never had sexual contact",
                                                      "females",
                                                      "males",
                                                      "females and males"))
yrbssNM2019$sexid <- factor(yrbssNM2019$sexid, labels = c("heterosexual",
                                                      "gay or lesbian",
                                                      "bisexual",
                                                      "not sure"))
yrbssNM2019$sexid2 <- factor(yrbssNM2019$sexid2, labels = c("heterosexual",
                                                      "sexual minority",
                                                      "unsure"))
yrbssNM2019$sexpart <- factor(yrbssNM2019$sexpart, labels = c("never had sex",
                                                      "opposite sex only",
                                                      "same sex only",
                                                      "both sexes"))
yrbssNM2019$sexpart2 <- factor(yrbssNM2019$sexpart2, labels = c("never had sex",
                                                      "opposite sex only",
                                                      "same sex only or both sexes"))
```

Plot the above

```{r sexual_minority_plots}
plot(yrbssNM2019$q66)
plot(yrbssNM2019$q65)
plot(yrbssNM2019$sexid)
plot(yrbssNM2019$sexid2)
plot(yrbssNM2019$sexpart)
plot(yrbssNM2019$sexpart2)
```
The dataset used for this demonstration includes the dichotomized versions
of the remaining questions. 

These variables are set to 1 when the answer is in the response of interest,
and 2 otherwise. More detail is provided in the dataset documentation. 

QN8 - QN11 address driving behaviors. For the remainder of this demo we
will focus on those variables to derive the percentage of students who
engage in specific behaviors such as not wearing a seat belt (QN8).

QN8 - How often do you wear a seat belt when riding in a car driven by someone
else. 

Behaviors of interest, per documentation, are responses of "Never" or "Rarely" 
to this question. We can arrive at the percentage of students who engaged in
behaviors of interest:

```{r seat_belt}
# Using dplyr
seat_belts <- yrbssNM2019 %>% 
  select(qn8) %>% 
  filter(!is.na(qn8)) %>% 
  summarise(pct = sum(qn8 == 1)/n())

seat_belts
```
We can break it down by different demographics.

```{r}
seat_belts_mf <- yrbssNM2019 %>% 
  select(sex, qn8) %>% 
  filter(!is.na(qn8), !is.na(sex)) %>% 
  group_by(sex) %>% 
  summarise(c = sum(!is.na(qn8)), 
            c1 = sum(qn8 == 1),
            c2 = sum(qn8 == 2),
            pct = sum(qn8 == 1)/n())

seat_belts_mf
ggplot(seat_belts_mf, aes(x = sex, y = pct)) + geom_col()
```

Try a model. Given the nature of the data, I am not sure what we are
predicting. Is it the likelihood that an individual will
engage in behavior of interest based on sex?

```{r}
yrbssNM2019$qn8 <- as.factor(yrbssNM2019$qn8)
yrbssNM2019$qn11 <- as.factor(yrbssNM2019$qn11)
sbm <- glm(qn8 ~ sex, data = yrbssNM2019, family = "binomial")
summary(sbm)
round(cbind(exp(coef(sbm)),
            exp(confint(sbm))), 3)
```

Do we understand this as males are ~34% less likely to wear a seat belt?











